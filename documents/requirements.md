# ComiCap - ソフトウェア要件仕様書

**バージョン**: 2.1.0
**最終更新日**: 2026-01-13
**対象**: Windows デスクトップアプリケーション

---

## 1. プロジェクト概要

### 1.1 目的
ComiCapは、Windows環境でスクリーンキャプチャ機能を提供するシステムトレイ常駐型アプリケーションである。ユーザーが必要な時に迅速にスクリーンショットを取得し、表示できる軽量なツールを提供することを目的とする。

### 1.2 スコープ
- Windows 10/11 デスクトップ環境での動作
- システムトレイからの操作
- プライマリモニタのキャプチャ
- アクティブウィンドウのキャプチャ
- キャプチャ画像の表示
- 画像の保存（PNG、JPEG、BMP形式）
- 保存先と画像形式の設定
- 設定の永続化

### 1.3 対象ユーザー
- スクリーンショットを頻繁に取得する必要があるユーザー
- 軽量なキャプチャツールを求めるユーザー
- Windows環境で作業を行う一般ユーザー

---

## 2. 機能要件

### 2.1 システムトレイ常駐機能
**要件ID**: FR-001
**優先度**: 高

**説明**:
アプリケーションはシステムトレイに常駐し、メインウィンドウを表示せずにバックグラウンドで動作する。

**詳細**:
- アプリケーション起動時、メインウィンドウは表示されない
- システムトレイにアイコンが表示される
- トレイアイコンのツールチップ: "ComiCap - Screen Capture Utility"
- アプリケーションは明示的に終了されるまで動作し続ける

**受入基準**:
- ✓ 起動時にメインウィンドウが表示されない
- ✓ システムトレイにアイコンが表示される
- ✓ ウィンドウを閉じてもアプリケーションが終了しない

---

### 2.2 コンテキストメニュー機能
**要件ID**: FR-002
**優先度**: 高

**説明**:
システムトレイアイコンを右クリックすると、操作メニューが表示される。

**メニュー項目**:
1. **表示(O)** - キャプチャ表示ウィンドウを開く
2. **キャプチャ(C)** - スクリーンキャプチャを実行
3. **名前を付けて保存(S)** - キャプチャ画像を任意の場所に保存
4. ---- セパレーター ----
5. **設定(T)** - 設定画面を開く
6. ---- セパレーター ----
7. **終了(X)** - アプリケーションを終了

**受入基準**:
- ✓ 右クリックでコンテキストメニューが表示される
- ✓ メニュー項目がすべて表示される
- ✓ 各メニュー項目にアクセスキーが設定されている
- ✓ セパレーターで論理的にグループ化されている

---

### 2.3 キャプチャ表示ウィンドウ機能
**要件ID**: FR-003
**優先度**: 高

**説明**:
「表示(O)」メニューを選択すると、キャプチャ画像を表示するためのウィンドウが開く。

**詳細**:
- ウィンドウサイズ: 800x600 ピクセル
- 起動位置: 画面中央
- ウィンドウタイトル: "ComiCap - Screen Capture"
- 画像表示エリア: ウィンドウ全体（マージン10px）
- 画像の表示方法: Uniform（アスペクト比を維持して拡大縮小）

**動作**:
- 同一ウィンドウは1つのみ作成される（シングルトンパターン）
- ウィンドウが既に開いている場合は、前面に表示してアクティブ化する
- ウィンドウを閉じてもアプリケーションは終了しない

**受入基準**:
- ✓ メニュー選択でウィンドウが開く
- ✓ ウィンドウが画面中央に表示される
- ✓ 複数のウィンドウが開かない
- ✓ ウィンドウを閉じてもアプリが終了しない

---

### 2.4 スクリーンキャプチャ機能（プライマリスクリーン）
**要件ID**: FR-004
**優先度**: 高

**説明**:
「キャプチャ(C)」メニューを選択すると、プライマリモニタの全画面をキャプチャする。

**詳細**:
- キャプチャ対象: プライマリモニタ全体
- キャプチャ方法: Windows API (BitBlt) を使用
- キャプチャモード: SRCCOPY
- 内部形式: System.Drawing.Bitmap
- 表示形式: WPF BitmapImage (PNG変換経由)

**動作フロー**:
1. メニュー選択時、表示ウィンドウが未作成の場合は自動的に作成
2. プライマリスクリーンのデバイスコンテキストを取得
3. BitBltでビットマップデータをコピー
4. Bitmapオブジェクトを作成
5. PNG形式でMemoryStreamに変換
6. WPF BitmapImageに変換
7. 表示ウィンドウの画像コントロールに設定

**エラーハンドリング**:
- デバイスコンテキスト取得失敗時: エラーメッセージ表示
- プライマリスクリーン情報取得失敗時: エラーメッセージ表示
- キャプチャ失敗時: エラーメッセージ表示
- リソースは必ず解放される（finally句で保証）

**受入基準**:
- ✓ プライマリスクリーン全体がキャプチャされる
- ✓ キャプチャ画像が表示ウィンドウに表示される
- ✓ エラー時にユーザーフレンドリーなメッセージが表示される
- ✓ リソースリークが発生しない

---

### 2.5 アクティブウィンドウキャプチャ機能
**要件ID**: FR-005
**優先度**: 中

**説明**:
現在フォアグラウンドにあるウィンドウのみをキャプチャする機能を実装している。

**詳細**:
- キャプチャ対象: 最前面のアクティブウィンドウ
- キャプチャ方法: Windows API (GetForegroundWindow + BitBlt)
- ウィンドウサイズの自動検出
- クライアント領域とフレームを含む全体をキャプチャ

**動作フロー**:
1. GetForegroundWindowでアクティブウィンドウハンドルを取得
2. GetWindowRectでウィンドウの矩形情報を取得
3. GetWindowDCでウィンドウのデバイスコンテキストを取得
4. BitBltでウィンドウ画像をコピー
5. Bitmapオブジェクトを作成

**エラーハンドリング**:
- アクティブウィンドウが存在しない: エラーメッセージ表示
- デバイスコンテキスト取得失敗: エラーメッセージ表示
- ウィンドウサイズ取得失敗: エラーメッセージ表示
- 無効なウィンドウサイズ（0以下）: エラーメッセージ表示

**受入基準**:
- ✓ アクティブウィンドウのみがキャプチャされる
- ✓ ウィンドウフレームを含む全体がキャプチャされる
- ✓ エラー時に適切なメッセージが表示される

**注**: 現在のバージョンでは実装済みだが、UIから直接呼び出すメニューは未実装

---

### 2.6 アプリケーション終了機能
**要件ID**: FR-006
**優先度**: 高

**説明**:
「終了(X)」メニューを選択すると、アプリケーションが完全に終了する。

**詳細**:
- すべてのリソースを適切に解放
- システムトレイアイコンを削除
- 開いているウィンドウをすべて閉じる
- アプリケーションプロセスを終了

**受入基準**:
- ✓ メニュー選択でアプリが終了する
- ✓ システムトレイアイコンが削除される
- ✓ プロセスが完全に終了する
- ✓ リソースリークが発生しない

---

### 2.7 画像保存機能
**要件ID**: FR-007
**優先度**: 高

**説明**:
キャプチャした画像をファイルとして保存する機能を提供する。

**詳細**:
- サポート形式: PNG、JPEG、BMP
- デフォルト保存先: 設定画面で指定可能（初期値: マイピクチャ\ComiCap）
- デフォルト画像形式: 設定画面で指定可能（初期値: PNG）
- ファイル名形式: `Screenshot_yyyyMMdd_HHmmss.{拡張子}`
  - 例: `Screenshot_20260113_153045.png`
- 保存先ディレクトリが存在しない場合は自動作成
- 同名ファイルが存在する場合は連番を追加: `Screenshot_20260113_153045_1.png`

**動作フロー**:
1. キャプチャ画像が存在することを確認
2. 設定から保存先パスと画像形式を取得
3. タイムスタンプを含むファイル名を生成
4. 保存先ディレクトリの存在を確認、なければ作成
5. ファイル名の重複をチェック、重複時は連番追加
6. 指定された形式で画像を保存
7. 成功時: 保存完了メッセージを表示（オプション）
8. 失敗時: エラーメッセージを表示

**エラーハンドリング**:
- キャプチャ画像が未取得: "保存する画像がありません"
- ディレクトリ作成失敗: "保存先フォルダを作成できません: {パス}"
- ファイル保存失敗: "画像の保存に失敗しました: {エラー詳細}"
- アクセス拒否: "保存先への書き込み権限がありません"

**受入基準**:
- ✓ PNG、JPEG、BMP形式で保存できる
- ✓ タイムスタンプ付きのファイル名で保存される
- ✓ 保存先ディレクトリが自動作成される
- ✓ ファイル名の重複が回避される
- ✓ エラー時に適切なメッセージが表示される

---

### 2.8 名前を付けて保存機能
**要件ID**: FR-008
**優先度**: 高

**説明**:
キャプチャした画像を任意のファイル名と場所で保存する機能を提供する。

**詳細**:
- SaveFileDialogを使用してファイル名と保存先を選択
- フィルター: "PNG画像 (*.png)|*.png|JPEG画像 (*.jpg;*.jpeg)|*.jpg;*.jpeg|BMP画像 (*.bmp)|*.bmp|すべてのファイル (*.*)|*.*"
- デフォルトファイル名: `Screenshot_yyyyMMdd_HHmmss`（拡張子なし）
- デフォルト保存先: 設定で指定された保存先（または前回の保存先）
- ファイル形式: 拡張子から自動判定

**動作フロー**:
1. キャプチャ画像が存在することを確認
2. SaveFileDialogを表示
3. ユーザーがファイル名と保存先を選択
4. OK押下時、指定されたパスに保存
5. キャンセル時、何もしない

**エラーハンドリング**:
- キャプチャ画像が未取得: "保存する画像がありません"
- 保存失敗: "画像の保存に失敗しました: {エラー詳細}"
- 非対応形式: "サポートされていない画像形式です"

**受入基準**:
- ✓ ファイルダイアログが表示される
- ✓ ユーザーが任意の場所とファイル名を指定できる
- ✓ キャンセル時に保存されない
- ✓ 指定された形式で正しく保存される

---

### 2.9 設定画面機能
**要件ID**: FR-009
**優先度**: 高

**説明**:
アプリケーションの動作設定を変更するための設定画面を提供する。

**詳細**:
- ウィンドウタイトル: "設定 - ComiCap"
- ウィンドウサイズ: 500x400 ピクセル
- モーダルダイアログとして表示
- 設定項目:
  1. **保存先設定**
     - ラベル: "デフォルト保存先"
     - テキストボックス（読み取り専用）
     - 「参照...」ボタン（FolderBrowserDialog）
     - デフォルト: `%USERPROFILE%\Pictures\ComiCap`
  2. **画像形式設定**
     - ラベル: "デフォルト画像形式"
     - コンボボックス: PNG / JPEG / BMP
     - デフォルト: PNG
  3. **JPEG品質設定**（画像形式がJPEGの場合のみ有効）
     - ラベル: "JPEG品質 (0-100)"
     - スライダー: 0～100
     - 数値表示
     - デフォルト: 90
- ボタン:
  - 「OK」: 設定を保存して閉じる
  - 「キャンセル」: 変更を破棄して閉じる
  - 「デフォルトに戻す」: すべての設定を初期値に戻す

**動作**:
- システムトレイメニューから「設定」を選択して表示
- 起動時に現在の設定値をロード
- OK押下時、設定を保存してダイアログを閉じる
- キャンセル押下時、変更を破棄してダイアログを閉じる

**受入基準**:
- ✓ メニューから設定画面が開く
- ✓ 現在の設定値が表示される
- ✓ 保存先をフォルダダイアログで選択できる
- ✓ 画像形式を変更できる
- ✓ JPEG品質を調整できる
- ✓ OK押下で設定が保存される
- ✓ キャンセルで変更が破棄される

---

### 2.10 設定の永続化機能
**要件ID**: FR-010
**優先度**: 高

**説明**:
ユーザーの設定をファイルに保存し、次回起動時に復元する機能を提供する。

**詳細**:
- 保存形式: JSON
- 保存場所: `%APPDATA%\ComiCap\settings.json`
- 保存内容:
  ```json
  {
    "SaveDirectory": "C:\\Users\\{username}\\Pictures\\ComiCap",
    "ImageFormat": "PNG",
    "JpegQuality": 90,
    "Version": "2.1.0"
  }
  ```
- デフォルト値:
  - SaveDirectory: `%USERPROFILE%\Pictures\ComiCap`
  - ImageFormat: PNG
  - JpegQuality: 90

**動作フロー**:
1. **起動時**:
   - 設定ファイルの存在を確認
   - 存在する場合: JSONを読み込み、設定を復元
   - 存在しない場合: デフォルト値を使用
   - パースエラー時: デフォルト値を使用、警告ログ出力
2. **設定保存時**:
   - 設定オブジェクトをJSONにシリアライズ
   - `%APPDATA%\ComiCap`ディレクトリを確認・作成
   - settings.jsonに書き込み
3. **設定リセット時**:
   - デフォルト値で設定を上書き
   - ファイルに保存

**エラーハンドリング**:
- 設定ファイル読み込み失敗: デフォルト値を使用（ログ出力）
- 設定ファイル書き込み失敗: エラーメッセージ表示
- JSONパースエラー: デフォルト値を使用（ログ出力）

**受入基準**:
- ✓ 設定がJSONファイルに保存される
- ✓ 次回起動時に設定が復元される
- ✓ 設定ファイルが破損していてもアプリが起動する
- ✓ デフォルト値が適切に設定される

---

### 2.11 範囲選択キャプチャ機能
**要件ID**: FR-011
**優先度**: 高

**説明**:
画面上の任意の矩形領域を選択してキャプチャする機能を提供する。

**詳細**:
- 全画面透過ウィンドウを表示してキャプチャ範囲を選択
- マウスドラッグで矩形領域を指定
- 選択中の領域を視覚的にハイライト表示
- スピードボタン（ツールバー）で主要操作にアクセス可能
- 選択完了後、指定領域のみをキャプチャ

**範囲選択ウィンドウの仕様**:
- **ウィンドウ特性**:
  - 全画面表示（プライマリモニタ全体をカバー）
  - 背景は半透明（黒色、透明度50%）
  - ウィンドウ枠なし（WindowStyle.None）
  - 常に最前面表示（Topmost）
  - Escキーでキャンセル可能
- **選択領域の表示**:
  - 選択中の矩形を明るく表示（元の画面が見える）
  - 選択枠を赤色の線で表示（太さ2px）
  - 矩形の四隅と辺の中央にリサイズハンドルを表示
- **マウス操作**:
  - 左クリック＋ドラッグ: 新しい矩形を選択
  - 選択済み矩形内をドラッグ: 矩形を移動
  - リサイズハンドルをドラッグ: 矩形のサイズ変更
  - ダブルクリック: 選択を確定してキャプチャ実行

**スピードボタンの仕様**:
- **配置**: 画面右上に縦配置（常に表示）
- **ボタン一覧**:
  1. **全画面キャプチャ** - 画面全体をキャプチャ
  2. **選択範囲キャプチャ** - 現在選択中の範囲をキャプチャ（デフォルト動作）
  3. **保存** - キャプチャした画像を即座に保存
  4. **キャンセル** - 範囲選択を中止
- **ボタンデザイン**:
  - サイズ: 48x48 ピクセル
  - アイコン＋ラベル表示
  - ホバー時に背景色変更
  - 半透明の背景（透明度70%）

**動作フロー**:
1. メニューから「範囲を選択してキャプチャ」を選択
2. 範囲選択ウィンドウが全画面で表示される
3. ユーザーがマウスで矩形領域を選択
4. スピードボタンまたはダブルクリックでキャプチャ実行
5. 選択範囲のみがキャプチャされる
6. キャプチャ結果をMainWindowに表示
7. 範囲選択ウィンドウを閉じる

**キーボードショートカット**:
- `Enter`: 選択範囲をキャプチャ
- `Esc`: キャンセル
- `Ctrl+S`: キャプチャして即座に保存
- `F`: 全画面キャプチャに切り替え

**エラーハンドリング**:
- 選択範囲が未指定: "キャプチャする範囲を選択してください"
- 選択範囲が小さすぎる（10px未満）: "選択範囲が小さすぎます"
- キャプチャ失敗: "画面のキャプチャに失敗しました: {エラー詳細}"

**受入基準**:
- ✓ 範囲選択ウィンドウが全画面で表示される
- ✓ マウスドラッグで矩形を選択できる
- ✓ 選択中の領域が視覚的にハイライトされる
- ✓ スピードボタンが表示され、各操作が実行できる
- ✓ 選択範囲のみがキャプチャされる
- ✓ Escキーでキャンセルできる
- ✓ キャプチャ後、範囲選択ウィンドウが閉じる

---

### 2.12 スライド自動キャプチャ機能
**要件ID**: FR-012
**優先度**: 高

**説明**:
ブラウザで表示したスライド（プレゼンテーション）を自動でページめくりしながら、各ページを連続キャプチャする機能を提供する。

**詳細**:
- 専用の設定ウィンドウでキャプチャパラメータを設定
- ブラウザを新規に起動（または既存ブラウザウィンドウを使用）
- 指定されたキー送信でページを自動めくり
- 各ページのキャプチャを自動実行
- 指定された回数または手動停止まで繰り返し

**設定項目**:
- **ブラウザURL**: キャプチャ対象のURL（省略可能）
- **ページめくりキー**: ページ送りに使用するキー
  - 選択肢: Right（→）, Left（←）, Down（↓）, Up（↑）, Space, PageDown, PageUp, Enter
  - デフォルト: Right
- **キャプチャ間隔**: ページめくり後のキャプチャまでの待機時間（ミリ秒）
  - 範囲: 100～10000ms
  - デフォルト: 1000ms
- **キャプチャ回数**: 自動キャプチャの回数
  - 範囲: 1～1000回
  - デフォルト: 10回
  - 0を指定で無限ループ（手動停止まで）
- **保存先フォルダ**: キャプチャ画像の保存先
  - デフォルト: 通常設定の保存先
- **画像形式**: PNG/JPEG/BMP
  - デフォルト: 通常設定の画像形式
- **JPEG品質**: JPEG選択時の品質（0-100）
  - デフォルト: 通常設定のJPEG品質
- **ファイル名プレフィックス**: ファイル名の接頭辞
  - デフォルト: "slide"
  - 生成ファイル名: "{prefix}_{連番}.{拡張子}" (例: slide_001.png)
- **ブラウザパス**: 起動するブラウザの実行ファイルパス（省略可能）
  - 省略時はシステムデフォルトブラウザを使用
- **ブラウザウィンドウを最大化**: ブラウザを最大化して起動するか
  - デフォルト: true

**スライドキャプチャ設定ウィンドウの仕様**:
- **ウィンドウ特性**:
  - モーダルダイアログ
  - サイズ: 600x700px程度
  - タイトル: "スライド自動キャプチャ設定"
- **UI要素**:
  - URL入力フィールド（テキストボックス）
  - ページめくりキー選択（コンボボックス）
  - キャプチャ間隔（数値入力、スライダー）
  - キャプチャ回数（数値入力）
  - 保存先フォルダ（テキストボックス + 参照ボタン）
  - 画像形式選択（コンボボックス）
  - JPEG品質（スライダー、JPEG選択時のみ有効）
  - ファイル名プレフィックス（テキストボックス）
  - ブラウザパス（テキストボックス + 参照ボタン、省略可能）
  - ブラウザを最大化（チェックボックス）
  - 開始ボタン
  - キャンセルボタン

**スライドキャプチャ実行フロー**:
1. **設定ウィンドウを表示**: ユーザーが設定を入力
2. **開始ボタンクリック**: 設定を検証
3. **ブラウザ起動**:
   - URLが指定されている場合: ブラウザを起動してURLを開く
   - URLが未指定の場合: 既存のアクティブウィンドウを使用
   - 最大化オプションがtrueの場合: ウィンドウを最大化
4. **初期待機**: 2秒待機（ページ読み込み完了待ち）
5. **キャプチャループ**:
   - アクティブウィンドウをフォアグラウンドに設定
   - 画面キャプチャを実行（全画面またはアクティブウィンドウ）
   - ファイル名生成: "{prefix}_{連番:000}.{拡張子}"
   - 画像を保存
   - 進捗表示を更新（"キャプチャ中: {現在}/{合計}"）
   - キャプチャ間隔待機
   - 指定されたキーをブラウザウィンドウに送信
   - キャプチャ間隔待機（ページ遷移完了待ち）
   - 次のページへ
6. **完了処理**:
   - "キャプチャ完了: {保存枚数}枚を保存しました" メッセージ表示
   - ダイアログを閉じる

**進捗表示ウィンドウ**:
- **ウィンドウ特性**:
  - モーダルダイアログ
  - サイズ: 400x200px
  - タイトル: "スライドキャプチャ実行中"
- **UI要素**:
  - 進捗バー
  - ステータスラベル: "キャプチャ中: {現在}/{合計}"
  - 停止ボタン: キャプチャを中断

**キー送信の実装**:
- Windows API `SendInput` を使用してキーイベントを送信
- ターゲットウィンドウをフォアグラウンドに設定後にキー送信
- キーダウン→キーアップの順で送信

**ブラウザ起動の実装**:
- `Process.Start` を使用
- URLが指定されている場合はブラウザパスとURLを引数に渡す
- ブラウザパスが未指定の場合はシェルデフォルトを使用

**エラーハンドリング**:
- ブラウザ起動失敗: "ブラウザの起動に失敗しました: {エラー詳細}"
- キャプチャ失敗: エラーをログに記録し、次のページに進む
- キー送信失敗: "キーの送信に失敗しました: {エラー詳細}"
- 保存フォルダアクセス不可: "保存先フォルダにアクセスできません"
- 無効な設定値: "設定値が無効です: {詳細}"

**受入基準**:
- ✓ 設定ウィンドウですべての設定項目を入力できる
- ✓ ブラウザが正常に起動する（URLが指定されている場合）
- ✓ 指定されたキーでページめくりが実行される
- ✓ 各ページが正常にキャプチャされる
- ✓ ファイル名が連番で生成される
- ✓ 指定された回数のキャプチャが完了する
- ✓ 進捗が表示され、停止ボタンで中断できる
- ✓ キャプチャ完了時に結果が表示される

---

## 3. 非機能要件

### 3.1 パフォーマンス要件
**要件ID**: NFR-001
**優先度**: 中

**詳細**:
- キャプチャ処理: 3秒以内に完了
- メモリ使用量: アイドル時 50MB以下
- 起動時間: 3秒以内
- システムトレイアイコンの応答: 1秒以内

**受入基準**:
- ✓ 通常のキャプチャ操作が3秒以内に完了
- ✓ アイドル時のメモリ使用量が基準内
- ✓ ユーザー操作に対する応答が迅速

---

### 3.2 信頼性要件
**要件ID**: NFR-002
**優先度**: 高

**詳細**:
- リソース管理: すべてのアンマネージドリソース（デバイスコンテキスト、Graphics）を適切に解放
- エラーハンドリング: すべてのUI操作とAPI呼び出しで例外処理を実装
- エラーメッセージ: ユーザーに理解可能な日本語メッセージを表示

**受入基準**:
- ✓ メモリリークが発生しない
- ✓ 例外によるクラッシュが発生しない
- ✓ エラー時に適切なメッセージが表示される

---

### 3.3 保守性要件
**要件ID**: NFR-003
**優先度**: 中

**詳細**:
- コード品質:
  - C# 12.0の最新機能を使用
  - Nullable参照型を有効化
  - File-scoped namespaces
  - XMLドキュメントコメント
- アーキテクチャ:
  - 関心の分離（キャプチャロジック、UI、トレイ管理）
  - シングルトンパターンでウィンドウ管理
- リソース管理:
  - Using宣言、try-finallyブロックの使用

**受入基準**:
- ✓ コードが明確で理解しやすい
- ✓ XMLコメントがすべてのpublic APIに存在
- ✓ モダンなC#パターンを使用

---

### 3.4 使いやすさ要件
**要件ID**: NFR-004
**優先度**: 高

**詳細**:
- UI言語: 日本語
- 操作性: 最小限のクリック数で主要機能にアクセス可能
- フィードバック: エラー時に明確なメッセージを表示
- 一貫性: Windowsの標準的なUI規則に従う

**受入基準**:
- ✓ 日本語UIで表示される
- ✓ 2クリック以内で主要機能にアクセス可能
- ✓ エラーメッセージが理解しやすい

---

## 4. システム要件

### 4.1 ハードウェア要件
**要件ID**: SYS-001

**最小要件**:
- CPU: 1GHz以上
- メモリ: 2GB以上
- ディスプレイ: 1024x768以上の解像度
- ストレージ: 100MB以上の空き容量

**推奨要件**:
- CPU: 2GHz以上
- メモリ: 4GB以上
- ディスプレイ: 1920x1080以上の解像度

---

### 4.2 ソフトウェア要件
**要件ID**: SYS-002

**必須**:
- OS: Windows 10 (64-bit) 以降、または Windows 11
- ランタイム: .NET 8.0 Runtime（デスクトップアプリ用）
- API: Win32 API（user32.dll, gdi32.dll）

**開発環境**:
- .NET SDK: 8.0以上
- IDE: Visual Studio 2022 または Visual Studio Code
- 言語: C# 12.0

---

### 4.3 依存パッケージ
**要件ID**: SYS-003

**NuGet パッケージ**:
- `H.NotifyIcon.Wpf` (2.1.4) - システムトレイアイコン実装
- `System.Drawing.Common` (8.0.10) - GDI+ Bitmapサポート

**フレームワーク**:
- WPF (Windows Presentation Foundation)
- .NET 8.0-windows

---

## 5. ユーザーインターフェース要件

### 5.1 システムトレイアイコン
**要件ID**: UI-001

**デザイン**:
- アイコン: icon.ico（プロジェクトに含まれる）
- サイズ: 16x16 ピクセル（システムトレイ標準）
- ツールチップ: "ComiCap - Screen Capture Utility"

**インタラクション**:
- 右クリック: コンテキストメニュー表示
- 左クリック: （現在未実装）

---

### 5.2 コンテキストメニュー
**要件ID**: UI-002

**デザイン**:
- フォント: システム標準
- 言語: 日本語
- アクセスキー: 各項目に設定

**構成**:
```
┌────────────────────────┐
│ 表示(O)                │
│ キャプチャ(C)          │
│ 名前を付けて保存(S)    │
├────────────────────────┤
│ 設定(T)                │
├────────────────────────┤
│ 終了(X)                │
└────────────────────────┘
```

---

### 5.3 キャプチャ表示ウィンドウ
**要件ID**: UI-003

**レイアウト**:
- サイズ: 800x600 ピクセル
- リサイズ: 可能
- 位置: 画面中央（初回表示時）
- タイトルバー: "ComiCap - Screen Capture"

**画像表示エリア**:
- マージン: 10px（全方向）
- Stretch: Uniform（アスペクト比維持）
- 配置: 中央揃え（水平・垂直）

---

## 6. 技術要件

### 6.1 アーキテクチャ要件
**要件ID**: TECH-001

**アプリケーション構造**:
- パターン: シングルトンパターン（MainWindow管理）
- アーキテクチャ: レイヤー分離
  - プレゼンテーション層: App.xaml, MainWindow.xaml
  - ビジネスロジック層: CaptureImpl
  - インフラストラクチャ層: Windows API P/Invoke

**ライフサイクル**:
- ShutdownMode: OnExplicitShutdown
- StartupUri: なし（トレイ常駐型）

---

### 6.2 Windows API 使用要件
**要件ID**: TECH-002

**使用するAPI**:

**user32.dll**:
- `GetDC` - デバイスコンテキスト取得
- `ReleaseDC` - デバイスコンテキスト解放
- `GetWindowDC` - ウィンドウDC取得
- `GetForegroundWindow` - アクティブウィンドウ取得
- `GetWindowRect` - ウィンドウ矩形情報取得

**gdi32.dll**:
- `BitBlt` - ビットブロック転送

**P/Invoke方式**:
- `LibraryImport` 属性を使用（.NET 7+の推奨方式）
- DllImportは使用しない（レガシー）

---

### 6.3 リソース管理要件
**要件ID**: TECH-003

**必須事項**:
- すべてのIDisposableリソースをusing宣言またはusing文で管理
- アンマネージドリソース（DC、Graphics）をfinallyブロックで確実に解放
- Bitmap生成エラー時は即座にDispose
- WPF BitmapImageはFreeze()してクロススレッド使用可能にする

**パターン**:
```csharp
IntPtr dc = IntPtr.Zero;
Bitmap? bmp = null;
try {
    // リソース取得と使用
} catch {
    bmp?.Dispose();
    throw;
} finally {
    // 確実な解放
    if (dc != IntPtr.Zero) ReleaseDC(...);
}
```

---

### 6.4 エラーハンドリング要件
**要件ID**: TECH-004

**必須事項**:
- すべてのUI イベントハンドラでtry-catch実装
- すべてのWindows API呼び出しで戻り値をチェック
- エラー時はユーザーにMessageBoxで通知
- 例外メッセージには具体的な内容を含める

**エラーメッセージ形式**:
```
スクリーンキャプチャ中にエラーが発生しました:
[具体的なエラー内容]
```

---

## 7. 制約事項

### 7.1 プラットフォーム制約
**制約ID**: CON-001

- Windows専用（Win32 API依存）
- macOS、Linux未対応
- .NET 8.0 ランタイムが必要

---

### 7.2 機能制約
**制約ID**: CON-002

**現在の制限**:
- プライマリモニタのみ対応（マルチモニタ環境で他のモニタは不可）
- キャプチャはUIスレッドで実行（ブロッキング動作）
- 画像の保存機能なし
- クリップボードへのコピー機能なし
- ホットキーサポートなし
- 設定の永続化なし

---

### 7.3 技術的制約
**制約ID**: CON-003

- 一部の保護されたウィンドウはキャプチャできない可能性あり
- UACダイアログなど管理者権限が必要なウィンドウのキャプチャには制限あり
- 画像変換のオーバーヘッド（GDI+ → PNG → WPF）が存在

---

## 8. 今後の拡張可能性

### 8.1 優先度：高（v2.1.0で実装予定）
- ~~画像の保存機能（PNG, JPEG, BMP形式）~~ ✓ 実装予定
- ~~設定画面（保存先、画像形式設定）~~ ✓ 実装予定
- ~~設定の永続化~~ ✓ 実装予定

### 8.2 優先度：高（将来のバージョン）
- マルチモニタサポート
- クリップボードへのコピー機能
- 自動保存機能（キャプチャ時に自動でファイル保存）

### 8.3 優先度：中
- グローバルホットキーサポート
- 非同期キャプチャ処理（async/await）
- キャプチャ範囲選択機能（矩形選択）
- アクティブウィンドウキャプチャのメニュー追加

### 8.4 優先度：低
- キャプチャ履歴機能
- 簡易的な画像編集（注釈、矢印、テキスト）
- 遅延キャプチャ（タイマー機能）
- 連続キャプチャ（動画キャプチャ）
- クラウドストレージへのアップロード

---

## 9. 受入テスト基準

### 9.1 機能テスト（基本機能）
- [ ] システムトレイに常駐できる
- [ ] トレイアイコン右クリックでメニューが表示される
- [ ] 「表示」メニューでウィンドウが開く
- [ ] ウィンドウは1つのみ作成される
- [ ] 「キャプチャ」メニューでスクリーンをキャプチャできる
- [ ] キャプチャ画像が表示ウィンドウに表示される
- [ ] 「終了」メニューでアプリが終了する
- [ ] ウィンドウを閉じてもアプリは終了しない

### 9.2 機能テスト（保存機能）
- [ ] 「名前を付けて保存」メニューが表示される
- [ ] キャプチャ前に保存メニューを選択するとエラーメッセージが表示される
- [ ] キャプチャ後に保存ダイアログが表示される
- [ ] PNG形式で保存できる
- [ ] JPEG形式で保存できる
- [ ] BMP形式で保存できる
- [ ] 保存したファイルが開ける
- [ ] ファイル名の重複時に連番が追加される

### 9.3 機能テスト（設定機能）
- [ ] 「設定」メニューで設定画面が開く
- [ ] 設定画面に現在の設定値が表示される
- [ ] 保存先フォルダを変更できる
- [ ] 画像形式を変更できる（PNG/JPEG/BMP）
- [ ] JPEG品質を調整できる
- [ ] 「OK」で設定が保存される
- [ ] 「キャンセル」で変更が破棄される
- [ ] 「デフォルトに戻す」で初期値に戻る
- [ ] アプリ再起動後も設定が保持される
- [ ] 設定ファイルがJSON形式で保存される

### 9.4 非機能テスト
- [ ] キャプチャ処理が3秒以内に完了する
- [ ] メモリリークが発生しない
- [ ] エラー時に適切なメッセージが表示される
- [ ] 連続キャプチャでメモリが増加し続けない
- [ ] 設定ファイルの読み書きが1秒以内に完了する

### 9.5 互換性テスト
- [ ] Windows 10 (64-bit) で動作する
- [ ] Windows 11 で動作する
- [ ] .NET 8.0 Runtime環境で動作する

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 2.1.0 | 2026-01-13 | 画像保存機能、設定画面機能、設定永続化機能を追加 | Claude |
| 2.0.0 | 2026-01-13 | .NET 8.0への最新化、要件書初版作成 | Claude |
| 1.0.0 | 2018 | 初版リリース (.NET Framework 4.5.2) | - |

---

## 付録A: 用語集

| 用語 | 説明 |
|-----|------|
| システムトレイ | Windows タスクバーの通知領域 |
| プライマリモニタ | 複数のモニタがある場合の主モニタ |
| BitBlt | Bit Block Transfer - ビットマップのブロック転送を行うGDI関数 |
| デバイスコンテキスト | Windowsの描画操作に使用するハンドル |
| P/Invoke | Platform Invoke - .NETからネイティブAPIを呼び出す機構 |
| LibraryImport | .NET 7+で導入されたP/Invokeの改良版 |

---

## 付録B: 参考資料

- [.NET 8.0 ドキュメント](https://learn.microsoft.com/ja-jp/dotnet/core/whats-new/dotnet-8)
- [WPF ドキュメント](https://learn.microsoft.com/ja-jp/dotnet/desktop/wpf/)
- [H.NotifyIcon GitHub](https://github.com/HavenDV/H.NotifyIcon)
- [WindowsAPIによるスクリーンキャプチャ](https://dobon.net/vb/dotnet/graphics/screencapture.html)
