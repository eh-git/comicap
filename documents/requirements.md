# ComiCap - ソフトウェア要件仕様書

**バージョン**: 2.0.0
**最終更新日**: 2026-01-13
**対象**: Windows デスクトップアプリケーション

---

## 1. プロジェクト概要

### 1.1 目的
ComiCapは、Windows環境でスクリーンキャプチャ機能を提供するシステムトレイ常駐型アプリケーションである。ユーザーが必要な時に迅速にスクリーンショットを取得し、表示できる軽量なツールを提供することを目的とする。

### 1.2 スコープ
- Windows 10/11 デスクトップ環境での動作
- システムトレイからの操作
- プライマリモニタのキャプチャ
- アクティブウィンドウのキャプチャ
- キャプチャ画像の表示

### 1.3 対象ユーザー
- スクリーンショットを頻繁に取得する必要があるユーザー
- 軽量なキャプチャツールを求めるユーザー
- Windows環境で作業を行う一般ユーザー

---

## 2. 機能要件

### 2.1 システムトレイ常駐機能
**要件ID**: FR-001
**優先度**: 高

**説明**:
アプリケーションはシステムトレイに常駐し、メインウィンドウを表示せずにバックグラウンドで動作する。

**詳細**:
- アプリケーション起動時、メインウィンドウは表示されない
- システムトレイにアイコンが表示される
- トレイアイコンのツールチップ: "ComiCap - Screen Capture Utility"
- アプリケーションは明示的に終了されるまで動作し続ける

**受入基準**:
- ✓ 起動時にメインウィンドウが表示されない
- ✓ システムトレイにアイコンが表示される
- ✓ ウィンドウを閉じてもアプリケーションが終了しない

---

### 2.2 コンテキストメニュー機能
**要件ID**: FR-002
**優先度**: 高

**説明**:
システムトレイアイコンを右クリックすると、操作メニューが表示される。

**メニュー項目**:
1. **表示(O)** - キャプチャ表示ウィンドウを開く
2. **キャプチャ(C)** - スクリーンキャプチャを実行
3. **終了(X)** - アプリケーションを終了

**受入基準**:
- ✓ 右クリックでコンテキストメニューが表示される
- ✓ メニュー項目がすべて表示される
- ✓ 各メニュー項目にアクセスキーが設定されている
- ✓ セパレーターで論理的にグループ化されている

---

### 2.3 キャプチャ表示ウィンドウ機能
**要件ID**: FR-003
**優先度**: 高

**説明**:
「表示(O)」メニューを選択すると、キャプチャ画像を表示するためのウィンドウが開く。

**詳細**:
- ウィンドウサイズ: 800x600 ピクセル
- 起動位置: 画面中央
- ウィンドウタイトル: "ComiCap - Screen Capture"
- 画像表示エリア: ウィンドウ全体（マージン10px）
- 画像の表示方法: Uniform（アスペクト比を維持して拡大縮小）

**動作**:
- 同一ウィンドウは1つのみ作成される（シングルトンパターン）
- ウィンドウが既に開いている場合は、前面に表示してアクティブ化する
- ウィンドウを閉じてもアプリケーションは終了しない

**受入基準**:
- ✓ メニュー選択でウィンドウが開く
- ✓ ウィンドウが画面中央に表示される
- ✓ 複数のウィンドウが開かない
- ✓ ウィンドウを閉じてもアプリが終了しない

---

### 2.4 スクリーンキャプチャ機能（プライマリスクリーン）
**要件ID**: FR-004
**優先度**: 高

**説明**:
「キャプチャ(C)」メニューを選択すると、プライマリモニタの全画面をキャプチャする。

**詳細**:
- キャプチャ対象: プライマリモニタ全体
- キャプチャ方法: Windows API (BitBlt) を使用
- キャプチャモード: SRCCOPY
- 内部形式: System.Drawing.Bitmap
- 表示形式: WPF BitmapImage (PNG変換経由)

**動作フロー**:
1. メニュー選択時、表示ウィンドウが未作成の場合は自動的に作成
2. プライマリスクリーンのデバイスコンテキストを取得
3. BitBltでビットマップデータをコピー
4. Bitmapオブジェクトを作成
5. PNG形式でMemoryStreamに変換
6. WPF BitmapImageに変換
7. 表示ウィンドウの画像コントロールに設定

**エラーハンドリング**:
- デバイスコンテキスト取得失敗時: エラーメッセージ表示
- プライマリスクリーン情報取得失敗時: エラーメッセージ表示
- キャプチャ失敗時: エラーメッセージ表示
- リソースは必ず解放される（finally句で保証）

**受入基準**:
- ✓ プライマリスクリーン全体がキャプチャされる
- ✓ キャプチャ画像が表示ウィンドウに表示される
- ✓ エラー時にユーザーフレンドリーなメッセージが表示される
- ✓ リソースリークが発生しない

---

### 2.5 アクティブウィンドウキャプチャ機能
**要件ID**: FR-005
**優先度**: 中

**説明**:
現在フォアグラウンドにあるウィンドウのみをキャプチャする機能を実装している。

**詳細**:
- キャプチャ対象: 最前面のアクティブウィンドウ
- キャプチャ方法: Windows API (GetForegroundWindow + BitBlt)
- ウィンドウサイズの自動検出
- クライアント領域とフレームを含む全体をキャプチャ

**動作フロー**:
1. GetForegroundWindowでアクティブウィンドウハンドルを取得
2. GetWindowRectでウィンドウの矩形情報を取得
3. GetWindowDCでウィンドウのデバイスコンテキストを取得
4. BitBltでウィンドウ画像をコピー
5. Bitmapオブジェクトを作成

**エラーハンドリング**:
- アクティブウィンドウが存在しない: エラーメッセージ表示
- デバイスコンテキスト取得失敗: エラーメッセージ表示
- ウィンドウサイズ取得失敗: エラーメッセージ表示
- 無効なウィンドウサイズ（0以下）: エラーメッセージ表示

**受入基準**:
- ✓ アクティブウィンドウのみがキャプチャされる
- ✓ ウィンドウフレームを含む全体がキャプチャされる
- ✓ エラー時に適切なメッセージが表示される

**注**: 現在のバージョンでは実装済みだが、UIから直接呼び出すメニューは未実装

---

### 2.6 アプリケーション終了機能
**要件ID**: FR-006
**優先度**: 高

**説明**:
「終了(X)」メニューを選択すると、アプリケーションが完全に終了する。

**詳細**:
- すべてのリソースを適切に解放
- システムトレイアイコンを削除
- 開いているウィンドウをすべて閉じる
- アプリケーションプロセスを終了

**受入基準**:
- ✓ メニュー選択でアプリが終了する
- ✓ システムトレイアイコンが削除される
- ✓ プロセスが完全に終了する
- ✓ リソースリークが発生しない

---

## 3. 非機能要件

### 3.1 パフォーマンス要件
**要件ID**: NFR-001
**優先度**: 中

**詳細**:
- キャプチャ処理: 3秒以内に完了
- メモリ使用量: アイドル時 50MB以下
- 起動時間: 3秒以内
- システムトレイアイコンの応答: 1秒以内

**受入基準**:
- ✓ 通常のキャプチャ操作が3秒以内に完了
- ✓ アイドル時のメモリ使用量が基準内
- ✓ ユーザー操作に対する応答が迅速

---

### 3.2 信頼性要件
**要件ID**: NFR-002
**優先度**: 高

**詳細**:
- リソース管理: すべてのアンマネージドリソース（デバイスコンテキスト、Graphics）を適切に解放
- エラーハンドリング: すべてのUI操作とAPI呼び出しで例外処理を実装
- エラーメッセージ: ユーザーに理解可能な日本語メッセージを表示

**受入基準**:
- ✓ メモリリークが発生しない
- ✓ 例外によるクラッシュが発生しない
- ✓ エラー時に適切なメッセージが表示される

---

### 3.3 保守性要件
**要件ID**: NFR-003
**優先度**: 中

**詳細**:
- コード品質:
  - C# 12.0の最新機能を使用
  - Nullable参照型を有効化
  - File-scoped namespaces
  - XMLドキュメントコメント
- アーキテクチャ:
  - 関心の分離（キャプチャロジック、UI、トレイ管理）
  - シングルトンパターンでウィンドウ管理
- リソース管理:
  - Using宣言、try-finallyブロックの使用

**受入基準**:
- ✓ コードが明確で理解しやすい
- ✓ XMLコメントがすべてのpublic APIに存在
- ✓ モダンなC#パターンを使用

---

### 3.4 使いやすさ要件
**要件ID**: NFR-004
**優先度**: 高

**詳細**:
- UI言語: 日本語
- 操作性: 最小限のクリック数で主要機能にアクセス可能
- フィードバック: エラー時に明確なメッセージを表示
- 一貫性: Windowsの標準的なUI規則に従う

**受入基準**:
- ✓ 日本語UIで表示される
- ✓ 2クリック以内で主要機能にアクセス可能
- ✓ エラーメッセージが理解しやすい

---

## 4. システム要件

### 4.1 ハードウェア要件
**要件ID**: SYS-001

**最小要件**:
- CPU: 1GHz以上
- メモリ: 2GB以上
- ディスプレイ: 1024x768以上の解像度
- ストレージ: 100MB以上の空き容量

**推奨要件**:
- CPU: 2GHz以上
- メモリ: 4GB以上
- ディスプレイ: 1920x1080以上の解像度

---

### 4.2 ソフトウェア要件
**要件ID**: SYS-002

**必須**:
- OS: Windows 10 (64-bit) 以降、または Windows 11
- ランタイム: .NET 8.0 Runtime（デスクトップアプリ用）
- API: Win32 API（user32.dll, gdi32.dll）

**開発環境**:
- .NET SDK: 8.0以上
- IDE: Visual Studio 2022 または Visual Studio Code
- 言語: C# 12.0

---

### 4.3 依存パッケージ
**要件ID**: SYS-003

**NuGet パッケージ**:
- `H.NotifyIcon.Wpf` (2.1.4) - システムトレイアイコン実装
- `System.Drawing.Common` (8.0.10) - GDI+ Bitmapサポート

**フレームワーク**:
- WPF (Windows Presentation Foundation)
- .NET 8.0-windows

---

## 5. ユーザーインターフェース要件

### 5.1 システムトレイアイコン
**要件ID**: UI-001

**デザイン**:
- アイコン: icon.ico（プロジェクトに含まれる）
- サイズ: 16x16 ピクセル（システムトレイ標準）
- ツールチップ: "ComiCap - Screen Capture Utility"

**インタラクション**:
- 右クリック: コンテキストメニュー表示
- 左クリック: （現在未実装）

---

### 5.2 コンテキストメニュー
**要件ID**: UI-002

**デザイン**:
- フォント: システム標準
- 言語: 日本語
- アクセスキー: 各項目に設定

**構成**:
```
┌─────────────────┐
│ 表示(O)         │
│ キャプチャ(C)   │
├─────────────────┤
│ 終了(X)         │
└─────────────────┘
```

---

### 5.3 キャプチャ表示ウィンドウ
**要件ID**: UI-003

**レイアウト**:
- サイズ: 800x600 ピクセル
- リサイズ: 可能
- 位置: 画面中央（初回表示時）
- タイトルバー: "ComiCap - Screen Capture"

**画像表示エリア**:
- マージン: 10px（全方向）
- Stretch: Uniform（アスペクト比維持）
- 配置: 中央揃え（水平・垂直）

---

## 6. 技術要件

### 6.1 アーキテクチャ要件
**要件ID**: TECH-001

**アプリケーション構造**:
- パターン: シングルトンパターン（MainWindow管理）
- アーキテクチャ: レイヤー分離
  - プレゼンテーション層: App.xaml, MainWindow.xaml
  - ビジネスロジック層: CaptureImpl
  - インフラストラクチャ層: Windows API P/Invoke

**ライフサイクル**:
- ShutdownMode: OnExplicitShutdown
- StartupUri: なし（トレイ常駐型）

---

### 6.2 Windows API 使用要件
**要件ID**: TECH-002

**使用するAPI**:

**user32.dll**:
- `GetDC` - デバイスコンテキスト取得
- `ReleaseDC` - デバイスコンテキスト解放
- `GetWindowDC` - ウィンドウDC取得
- `GetForegroundWindow` - アクティブウィンドウ取得
- `GetWindowRect` - ウィンドウ矩形情報取得

**gdi32.dll**:
- `BitBlt` - ビットブロック転送

**P/Invoke方式**:
- `LibraryImport` 属性を使用（.NET 7+の推奨方式）
- DllImportは使用しない（レガシー）

---

### 6.3 リソース管理要件
**要件ID**: TECH-003

**必須事項**:
- すべてのIDisposableリソースをusing宣言またはusing文で管理
- アンマネージドリソース（DC、Graphics）をfinallyブロックで確実に解放
- Bitmap生成エラー時は即座にDispose
- WPF BitmapImageはFreeze()してクロススレッド使用可能にする

**パターン**:
```csharp
IntPtr dc = IntPtr.Zero;
Bitmap? bmp = null;
try {
    // リソース取得と使用
} catch {
    bmp?.Dispose();
    throw;
} finally {
    // 確実な解放
    if (dc != IntPtr.Zero) ReleaseDC(...);
}
```

---

### 6.4 エラーハンドリング要件
**要件ID**: TECH-004

**必須事項**:
- すべてのUI イベントハンドラでtry-catch実装
- すべてのWindows API呼び出しで戻り値をチェック
- エラー時はユーザーにMessageBoxで通知
- 例外メッセージには具体的な内容を含める

**エラーメッセージ形式**:
```
スクリーンキャプチャ中にエラーが発生しました:
[具体的なエラー内容]
```

---

## 7. 制約事項

### 7.1 プラットフォーム制約
**制約ID**: CON-001

- Windows専用（Win32 API依存）
- macOS、Linux未対応
- .NET 8.0 ランタイムが必要

---

### 7.2 機能制約
**制約ID**: CON-002

**現在の制限**:
- プライマリモニタのみ対応（マルチモニタ環境で他のモニタは不可）
- キャプチャはUIスレッドで実行（ブロッキング動作）
- 画像の保存機能なし
- クリップボードへのコピー機能なし
- ホットキーサポートなし
- 設定の永続化なし

---

### 7.3 技術的制約
**制約ID**: CON-003

- 一部の保護されたウィンドウはキャプチャできない可能性あり
- UACダイアログなど管理者権限が必要なウィンドウのキャプチャには制限あり
- 画像変換のオーバーヘッド（GDI+ → PNG → WPF）が存在

---

## 8. 今後の拡張可能性

### 8.1 優先度：高
- マルチモニタサポート
- 画像の保存機能（PNG, JPEG形式）
- クリップボードへのコピー機能

### 8.2 優先度：中
- グローバルホットキーサポート
- 設定画面（保存先、形式、ホットキー設定）
- 非同期キャプチャ処理（async/await）

### 8.3 優先度：低
- キャプチャ履歴機能
- 簡易的な画像編集（注釈、矢印、テキスト）
- 遅延キャプチャ（タイマー機能）
- 連続キャプチャ（動画キャプチャ）

---

## 9. 受入テスト基準

### 9.1 機能テスト
- [ ] システムトレイに常駐できる
- [ ] トレイアイコン右クリックでメニューが表示される
- [ ] 「表示」メニューでウィンドウが開く
- [ ] ウィンドウは1つのみ作成される
- [ ] 「キャプチャ」メニューでスクリーンをキャプチャできる
- [ ] キャプチャ画像が表示ウィンドウに表示される
- [ ] 「終了」メニューでアプリが終了する
- [ ] ウィンドウを閉じてもアプリは終了しない

### 9.2 非機能テスト
- [ ] キャプチャ処理が3秒以内に完了する
- [ ] メモリリークが発生しない
- [ ] エラー時に適切なメッセージが表示される
- [ ] 連続キャプチャでメモリが増加し続けない

### 9.3 互換性テスト
- [ ] Windows 10 (64-bit) で動作する
- [ ] Windows 11 で動作する
- [ ] .NET 8.0 Runtime環境で動作する

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 2.0.0 | 2026-01-13 | .NET 8.0への最新化、要件書初版作成 | Claude |
| 1.0.0 | 2018 | 初版リリース (.NET Framework 4.5.2) | - |

---

## 付録A: 用語集

| 用語 | 説明 |
|-----|------|
| システムトレイ | Windows タスクバーの通知領域 |
| プライマリモニタ | 複数のモニタがある場合の主モニタ |
| BitBlt | Bit Block Transfer - ビットマップのブロック転送を行うGDI関数 |
| デバイスコンテキスト | Windowsの描画操作に使用するハンドル |
| P/Invoke | Platform Invoke - .NETからネイティブAPIを呼び出す機構 |
| LibraryImport | .NET 7+で導入されたP/Invokeの改良版 |

---

## 付録B: 参考資料

- [.NET 8.0 ドキュメント](https://learn.microsoft.com/ja-jp/dotnet/core/whats-new/dotnet-8)
- [WPF ドキュメント](https://learn.microsoft.com/ja-jp/dotnet/desktop/wpf/)
- [H.NotifyIcon GitHub](https://github.com/HavenDV/H.NotifyIcon)
- [WindowsAPIによるスクリーンキャプチャ](https://dobon.net/vb/dotnet/graphics/screencapture.html)
